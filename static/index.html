<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Psychological Experiment</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }

      .hidden {
        display: none !important;
      }

      /* ---------- TOP NAV (Back / Restart) ---------- */
      #topNav {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: min(760px, calc(100vw - 40px));
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        z-index: 10000;
        pointer-events: none;
      }
      #topNav .navInner {
        width: 100%;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        pointer-events: auto;
      }
      #topNav button {
        padding: 8px 12px;
        margin: 0;
      }
      #topNav button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ---------- CENTERED PAGES ---------- */
      .centerPage {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 40px);
      }
      .centerBox {
        text-align: center;
        width: min(560px, 100%);
      }
      .centerBox .stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 14px;
        margin-top: 14px;
      }

      /* ---------- radio groups like Google Forms ---------- */
      .qBlock {
        width: min(520px, 100%);
        text-align: center;
      }
      .qTitle {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .radioCol {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .radioOpt {
        width: min(360px, 100%);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 10px;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background: #fff;
      }
      .radioOpt input[type="radio"] {
        transform: scale(1.2);
      }

      /* ---------- TASKS ---------- */
      #tasks {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
        margin-bottom: 10px;
        align-items: flex-start;
      }

      .task {
        display: inline-block;
        width: fit-content;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;

        padding: 10px 14px;
        background: #eee;
        border: 1px solid #ccc;
        cursor: grab;
        border-radius: 6px;
        user-select: none;
      }

      /* ---------- SLOTS ---------- */
      .dayGrid {
        display: grid;
        grid-template-columns: repeat(5, minmax(160px, 1fr));
        gap: 12px;
        margin-top: 10px;
      }

      @media (max-width: 1100px) {
        .dayGrid {
          grid-template-columns: repeat(3, minmax(160px, 1fr));
        }
      }
      @media (max-width: 700px) {
        .dayGrid {
          grid-template-columns: repeat(2, minmax(150px, 1fr));
        }
      }

      .slot {
        border: 1px dashed #999;
        min-height: 110px;
        padding: 10px;
        border-radius: 8px;
        background: #fff;
      }

      .slotHeader {
        font-weight: 700;
        margin-bottom: 8px;
      }

      .slot .task {
        white-space: normal;
        width: auto;
        max-width: 100%;
        margin: 6px 0 0 0;
        cursor: grab;
      }

      /* ---------- STRESS BANNER ---------- */
      #stress {
        position: fixed;
        left: 50%;
        bottom: 26px;
        transform: translateX(-50%);

        width: min(760px, calc(100vw - 40px));
        padding: 14px 18px;

        display: none;
        align-items: center;
        justify-content: center;

        font-size: 20px;
        font-weight: 800;
        text-align: center;

        background: rgba(255, 80, 80, 0.22);
        border: 2px solid rgba(180, 0, 0, 0.25);
        border-radius: 999px;

        z-index: 9999;
        pointer-events: none;
      }

      @keyframes stressPulse {
        0% {
          transform: translateX(-50%) scale(1);
        }
        50% {
          transform: translateX(-50%) scale(1.03);
        }
        100% {
          transform: translateX(-50%) scale(1);
        }
      }

      #stress.show {
        display: flex;
        animation: stressPulse 0.9s ease-in-out infinite;
      }

      /* ---------- NON-BLOCKING MODAL ---------- */
      #msgModal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10050;
      }
      #msgModal.show {
        display: flex;
      }
      #msgBackdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
      }
      #msgBox {
        position: relative;
        width: min(520px, calc(100vw - 40px));
        background: #fff;
        border-radius: 12px;
        padding: 18px 18px 14px;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.25);
        text-align: center;
      }
      #msgText {
        font-size: 15px;
        margin: 0 0 10px 0;
        white-space: pre-line;
      }
      #msgOkBtn {
        padding: 9px 18px;
        margin-top: 6px;
      }

      button {
        padding: 10px 20px;
        margin-top: 10px;
      }

      input[type="number"] {
        padding: 10px;
        width: 260px;
        max-width: 100%;
      }

      .btnRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
        justify-content: center;
      }

      .muted {
        opacity: 0.7;
        font-size: 13px;
      }

      /* ---------- REPRESSION (all questions) ---------- */
      .repList {
        width: min(560px, 100%);
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 10px;
        text-align: left;
      }
      .repItem {
        border: 1px solid #e3e3e3;
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }
      .repItemTitle {
        font-weight: 700;
        margin-bottom: 8px;
        text-align: center;
      }
      .repScale {
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .repScale label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      #repError {
        color: #b00020;
        display: none;
        text-align: center;
        margin-top: 8px;
      }
    </style>
  </head>

  <body>
    <!-- TOP NAV (always visible) -->
    <div id="topNav">
      <div class="navInner">
        <button id="backBtn" type="button" onclick="goBack()">← Back</button>
        <button id="restartBtn" type="button" onclick="restartExperiment()">
          ⟲ Restart
        </button>
      </div>
    </div>

    <div id="stress">⚠ PLEASE FINISH AS FAST AS POSSIBLE ⚠</div>

    <!-- NON-BLOCKING MODAL -->
    <div id="msgModal" class="hidden">
      <div id="msgBackdrop"></div>
      <div id="msgBox">
        <p id="msgText"></p>
        <button id="msgOkBtn" type="button">OK</button>
      </div>
    </div>

    <!-- CONSENT -->
    <div id="consent" class="centerPage">
      <div class="centerBox">
        <h2>Consent</h2>
        <p>I agree to participate in this study.</p>

        <div class="btnRow">
          <button onclick="consentAgree()">I Agree</button>
          <button onclick="consentDisagree()">I Disagree</button>
        </div>
      </div>
    </div>

    <!-- DISAGREE END PAGE -->
    <div id="disagree" class="hidden centerPage">
      <div class="centerBox">
        <h2>Thank you, goodbye.</h2>
        <p>You may now close this page.</p>
      </div>
    </div>

    <!-- DEMOGRAPHICS -->
    <div id="demo" class="hidden centerPage">
      <div class="centerBox">
        <h2>Demographics</h2>

        <div class="stack">
          <div class="qBlock">
            <div class="qTitle">Do you speak English?</div>
            <div class="radioCol" id="englishGroup">
              <label class="radioOpt">
                <input type="radio" name="speakEnglish" value="yes" />
                Yes
              </label>
              <label class="radioOpt">
                <input type="radio" name="speakEnglish" value="no" />
                No
              </label>
            </div>
          </div>

          <div class="qBlock">
            <div class="qTitle">Age (18-99)</div>
            <input
              id="ageInput"
              type="number"
              min="18"
              max="99"
              placeholder="Age"
            />
          </div>

          <div class="qBlock">
            <div class="qTitle">Gender</div>
            <div class="radioCol" id="genderGroup">
              <label class="radioOpt">
                <input type="radio" name="gender" value="male" />
                Male
              </label>
              <label class="radioOpt">
                <input type="radio" name="gender" value="female" />
                Female
              </label>
              <label class="radioOpt">
                <input type="radio" name="gender" value="other" />
                Other
              </label>
            </div>
          </div>

          <div class="qBlock">
            <div class="qTitle">Residence</div>
            <div class="radioCol" id="resGroup">
              <label class="radioOpt">
                <input type="radio" name="residence" value="north" />
                North
              </label>
              <label class="radioOpt">
                <input type="radio" name="residence" value="central" />
                Central
              </label>
              <label class="radioOpt">
                <input type="radio" name="residence" value="south" />
                South
              </label>
            </div>
          </div>

          <div class="qBlock">
            <div class="qTitle">Socioeconomic status</div>
            <div class="radioCol" id="sesGroup">
              <label class="radioOpt">
                <input type="radio" name="socioeconomic" value="low" />
                Low
              </label>
              <label class="radioOpt">
                <input type="radio" name="socioeconomic" value="medium" />
                Medium
              </label>
              <label class="radioOpt">
                <input type="radio" name="socioeconomic" value="high" />
                High
              </label>
            </div>
          </div>

          <div class="qBlock">
            <div class="qTitle">Marital status</div>
            <div class="radioCol" id="maritalGroup">
              <label class="radioOpt">
                <input type="radio" name="marital" value="single" />
                Single
              </label>
              <label class="radioOpt">
                <input type="radio" name="marital" value="married" />
                Married
              </label>
            </div>
          </div>

          <div class="qBlock">
            <div class="qTitle">Level of education</div>
            <div class="radioCol" id="eduGroup">
              <label class="radioOpt">
                <input
                  type="radio"
                  name="education"
                  value="until_high_school"
                />
                Until high school
              </label>
              <label class="radioOpt">
                <input type="radio" name="education" value="high_school" />
                High School
              </label>
              <label class="radioOpt">
                <input type="radio" name="education" value="ba" />
                B.A
              </label>
              <label class="radioOpt">
                <input
                  type="radio"
                  name="education"
                  value="masters_or_higher"
                />
                Master's degree or higher
              </label>
            </div>
          </div>

          <button onclick="submitDemo()">Next</button>
        </div>
      </div>
    </div>

    <!-- REPRESSION -->
    <div id="rep" class="hidden centerPage">
      <div class="centerBox">
        <h2>Repression Questionnaire</h2>
        <div class="muted">Please answer all questions (1–5).</div>

        <div id="repContainer" class="repList"></div>

        <div id="repError">Please answer all 15 questions to continue.</div>

        <button onclick="repSubmitAll()">Next</button>
      </div>
    </div>

    <!-- EXPERIMENT -->
    <div id="exp" class="hidden">
      <h2>Daily Schedule</h2>

      <h4>Tasks</h4>
      <div class="muted">
        Drag tasks into a time slot. Total per slot must be ≤ 60 minutes.
      </div>

      <div id="tasks">
        <div class="task" draggable="true" data-task-id="t1" data-minutes="30">
          Reply to urgent email (30 min)
        </div>
        <div class="task" draggable="true" data-task-id="t2" data-minutes="20">
          Prepare daily report (20 min)
        </div>
        <div class="task" draggable="true" data-task-id="t3" data-minutes="15">
          Schedule meeting (15 min)
        </div>
      </div>

      <div class="btnRow" style="justify-content: flex-start">
        <button onclick="resetSchedule()">Reset schedule</button>
        <button onclick="submitExperiment()">Finish Tasks</button>
      </div>

      <h4 style="margin-top: 20px">Day</h4>

      <div class="dayGrid">
        <div
          class="slot"
          data-time="08:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">08:00</div>
        </div>
        <div
          class="slot"
          data-time="09:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">09:00</div>
        </div>
        <div
          class="slot"
          data-time="10:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">10:00</div>
        </div>
        <div
          class="slot"
          data-time="11:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">11:00</div>
        </div>
        <div
          class="slot"
          data-time="12:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">12:00</div>
        </div>
        <div
          class="slot"
          data-time="13:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">13:00</div>
        </div>
        <div
          class="slot"
          data-time="14:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">14:00</div>
        </div>
        <div
          class="slot"
          data-time="15:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">15:00</div>
        </div>
        <div
          class="slot"
          data-time="16:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">16:00</div>
        </div>
        <div
          class="slot"
          data-time="17:00"
          ondragover="allow(event)"
          ondrop="drop(event)"
        >
          <div class="slotHeader">17:00</div>
        </div>
      </div>
    </div>

    <!-- STRESS RATING -->
    <div id="rate" class="hidden centerPage">
      <div class="centerBox">
        <h2>Stress Level (1–10)</h2>

        <div class="stack">
          <input id="stressRating" type="number" min="1" max="10" />

          <div id="rateError" style="color: #b00020; display: none">
            Please choose a number between 1 and 10.
          </div>

          <button onclick="finish()">Submit</button>
        </div>
      </div>
    </div>

    <!-- DONE -->
    <div id="done" class="hidden centerPage">
      <div class="centerBox">
        <h2>Thank you very much!</h2>
        <p>You may now close this page.</p>
      </div>
    </div>

    <script>
      // =====================================================
      // IMPORTANT CHANGE:
      // Use sessionStorage so closing the tab/window resets
      // the experiment (no resume next time).
      // =====================================================
      const STORAGE = sessionStorage;
      const LS_KEY = "exp_state_v1";

      function loadState() {
        try {
          return JSON.parse(STORAGE.getItem(LS_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveState(partial) {
        const cur = loadState();
        const next = { ...cur, ...partial };
        STORAGE.setItem(LS_KEY, JSON.stringify(next));
        return next;
      }
      function clearState() {
        STORAGE.removeItem(LS_KEY);
      }

      // =========================
      // Global runtime vars
      // =========================
      let pid = null;
      let stress = 0;

      let stressStarted = false;
      let stressFireAt = null;
      let stressShown = false;

      // ---- LOOPING SOUND state ----
      let audioCtx = null;
      let beepTimer = null;
      let beepingActive = false;

      // Audio unlock flag (required by browsers)
      let audioUnlocked = false;

      // =========================
      // Nav visibility rules
      // =========================
      function updateNavVisibility(pageId) {
        const backBtn = document.getElementById("backBtn");

        // Hide Back on: Daily Schedule, Disagree Goodbye, Stress Rating, DONE
        const hideBack =
          pageId === "exp" ||
          pageId === "disagree" ||
          pageId === "rate" ||
          pageId === "done";

        backBtn.style.display = hideBack ? "none" : "";
      }

      // =========================
      // Back / Restart
      // =========================
      function getHistory() {
        const s = loadState();
        return Array.isArray(s.history) ? s.history : [];
      }
      function setHistory(arr) {
        saveState({ history: arr });
        updateBackButton();
      }

      function updateBackButton() {
        const s = loadState();
        const pageId = s.currentPage || "consent";

        // Always enforce visibility rule here too (so it can't "come back")
        updateNavVisibility(pageId);

        const h = getHistory();
        const backBtn = document.getElementById("backBtn");
        backBtn.disabled = h.length <= 1;
      }

      function goBack() {
        const h = getHistory();
        if (h.length <= 1) return;
        h.pop();
        const prev = h[h.length - 1];
        setHistory(h);
        show(prev, { pushHistory: false });
      }

      function restartExperiment() {
        hideStress();
        hideMsg();

        clearState();

        pid = null;
        stress = 0;
        stressStarted = false;
        stressFireAt = null;
        stressShown = false;

        resetAllInputsAndScheduleUI();
        show("consent", { pushHistory: true, force: true });
      }

      // =========================
      // Helpers: UI reset
      // =========================
      function resetAllInputsAndScheduleUI() {
        document
          .querySelectorAll('input[name="speakEnglish"]')
          .forEach((i) => (i.checked = false));
        document.getElementById("ageInput").value = "";
        document
          .querySelectorAll('input[name="gender"]')
          .forEach((i) => (i.checked = false));
        document
          .querySelectorAll('input[name="residence"]')
          .forEach((i) => (i.checked = false));
        document
          .querySelectorAll('input[name="socioeconomic"]')
          .forEach((i) => (i.checked = false));
        document
          .querySelectorAll('input[name="marital"]')
          .forEach((i) => (i.checked = false));
        document
          .querySelectorAll('input[name="education"]')
          .forEach((i) => (i.checked = false));

        document.getElementById("repError").style.display = "none";

        document.getElementById("stressRating").value = "";
        document.getElementById("rateError").style.display = "none";

        const tasksContainer = document.getElementById("tasks");
        document
          .querySelectorAll(".task")
          .forEach((t) => tasksContainer.appendChild(t));
      }

      // =========================
      // Audio / beeps
      // =========================
      function ensureAudio() {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx && Ctx) audioCtx = new Ctx();
        if (audioCtx && audioCtx.state === "suspended") {
          audioCtx.resume().catch(() => {});
        }
      }

      function playOneBeep() {
        ensureAudio();
        if (!audioCtx) return;

        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = "square";
        osc.frequency.setValueAtTime(650, now);
        osc.frequency.exponentialRampToValueAtTime(1250, now + 0.12);

        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.18, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.16);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start(now);
        osc.stop(now + 0.18);
      }

      function startBeepLoop() {
        if (beepingActive) return;
        beepingActive = true;
        playOneBeep();
        beepTimer = setInterval(playOneBeep, 1300);
      }

      function stopBeepLoop() {
        beepingActive = false;
        if (beepTimer) {
          clearInterval(beepTimer);
          beepTimer = null;
        }
      }

      function unlockAudioOnce() {
        if (audioUnlocked) return;

        ensureAudio();
        if (!audioCtx) return;

        audioCtx
          .resume()
          .then(() => {
            audioUnlocked = true;

            const expVisible = !document
              .getElementById("exp")
              .classList.contains("hidden");
            const s = loadState();
            if (
              expVisible &&
              (s.stressShown ||
                document.getElementById("stress").classList.contains("show"))
            ) {
              startBeepLoop();
            }
          })
          .catch(() => {});
      }

      function showStress() {
        document.getElementById("stress").classList.add("show");
        stressShown = true;
        saveState({ stressShown: true });
        startBeepLoop();
      }

      function hideStress() {
        document.getElementById("stress").classList.remove("show");
        stopBeepLoop();
      }

      function startStressIfNeeded() {
        if (!stress) return;

        const s = loadState();
        if (s.stressShown) {
          const expVisible = !document
            .getElementById("exp")
            .classList.contains("hidden");
          if (expVisible) showStress();
          return;
        }

        if (s.stressFireAt && typeof s.stressFireAt === "number") {
          stressFireAt = s.stressFireAt;
        }

        if (!stressFireAt) {
          const minDelayMs = 5000; // 5 seconds
          const maxDelayMs = 15000; // 15 seconds
          const delayMs =
            minDelayMs +
            Math.floor(Math.random() * (maxDelayMs - minDelayMs + 1));
          stressFireAt = Date.now() + delayMs;
          saveState({ stressFireAt, stressStarted: true });
        }

        stressStarted = true;

        const remaining = stressFireAt - Date.now();
        if (remaining <= 0) {
          const expVisible = !document
            .getElementById("exp")
            .classList.contains("hidden");
          if (expVisible) showStress();
          return;
        }

        setTimeout(() => {
          const expVisible = !document
            .getElementById("exp")
            .classList.contains("hidden");
          if (expVisible) showStress();
        }, remaining);
      }

      function showMsg(text) {
        unlockAudioOnce();
        const modal = document.getElementById("msgModal");
        document.getElementById("msgText").innerText = text;

        modal.classList.remove("hidden");
        modal.classList.add("show");
        document.getElementById("msgOkBtn").focus();
      }

      function hideMsg() {
        const modal = document.getElementById("msgModal");
        modal.classList.remove("show");
        modal.classList.add("hidden");
      }

      function show(id, opts = {}) {
        const { pushHistory = true, force = false } = opts;

        const pages = [
          "consent",
          "demo",
          "rep",
          "exp",
          "rate",
          "done",
          "disagree",
        ];
        pages.forEach((p) =>
          document.getElementById(p).classList.add("hidden")
        );
        document.getElementById(id).classList.remove("hidden");

        updateNavVisibility(id);

        if (force || loadState().currentPage !== id) {
          saveState({ currentPage: id });
        }

        if (pushHistory) {
          const h = getHistory();
          const last = h[h.length - 1];
          if (last !== id) h.push(id);
          setHistory(h);
        } else {
          updateBackButton();
        }

        if (id === "rep") {
          buildRepressionAll();
          restoreRepUI();
        }

        if (id === "exp") {
          wireTaskDragHandlers();
          restoreScheduleUI();
          startStressIfNeeded();
          if (loadState().stressShown) showStress();
        }

        if (id === "rate" || id === "done" || id === "disagree") {
          hideStress();
        }

        if (id === "rate") restoreRatingUI();
        if (id === "demo") restoreDemoUI();
      }

      const repQuestions = Array.from({ length: 15 }, (_, i) => `Q${i + 1}`);

      function buildRepressionAll() {
        const container = document.getElementById("repContainer");
        container.innerHTML = "";

        repQuestions.forEach((qText, idx) => {
          const qIndex = idx + 1;

          const item = document.createElement("div");
          item.className = "repItem";

          const title = document.createElement("div");
          title.className = "repItemTitle";
          title.innerText = qText;
          item.appendChild(title);

          const scale = document.createElement("div");
          scale.className = "repScale";

          for (let s = 1; s <= 5; s++) {
            const lab = document.createElement("label");
            const inp = document.createElement("input");
            inp.type = "radio";
            inp.name = `rep_${qIndex}`;
            inp.value = String(s);

            inp.addEventListener("change", persistRepUI);

            lab.appendChild(inp);
            lab.appendChild(document.createTextNode(` ${s}`));
            scale.appendChild(lab);
          }

          item.appendChild(scale);
          container.appendChild(item);
        });
      }

      function persistRepUI() {
        const repAnswers = {};
        for (let i = 1; i <= 15; i++) {
          const sel = document.querySelector(`input[name="rep_${i}"]:checked`);
          if (sel) repAnswers[i] = parseInt(sel.value, 10);
        }
        saveState({ repAnswers });
      }

      function restoreRepUI() {
        const s = loadState();
        const repAnswers = s.repAnswers || {};
        for (let i = 1; i <= 15; i++) {
          const v = repAnswers[i];
          if (v) {
            const el = document.querySelector(
              `input[name="rep_${i}"][value="${v}"]`
            );
            if (el) el.checked = true;
          }
        }
      }

      async function repSubmitAll() {
        const answers = [];
        const missing = [];

        for (let i = 1; i <= 15; i++) {
          const sel = document.querySelector(`input[name="rep_${i}"]:checked`);
          if (!sel) missing.push(i);
          else {
            answers.push({
              qIndex: i,
              question: repQuestions[i - 1],
              score: parseInt(sel.value, 10),
            });
          }
        }

        if (missing.length > 0) {
          document.getElementById("repError").style.display = "block";
          const firstEl = document.querySelector(
            `input[name="rep_${missing[0]}"]`
          );
          if (firstEl)
            firstEl.scrollIntoView({ behavior: "smooth", block: "center" });
          return;
        }

        document.getElementById("repError").style.display = "none";

        if (!pid)
          return alert(
            "Missing participant session. Please restart the experiment."
          );

        const res = await fetch(`/save/rep`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ participant_id: pid, data: answers }),
        });

        if (!res.ok)
          return alert(
            "Failed to save repression questionnaire. Please try again."
          );

        saveState({ repCompleted: true });
        show("exp");
      }

      function wireTaskDragHandlers() {
        document.querySelectorAll(".task").forEach((el) => {
          el.addEventListener("dragstart", (e) => {
            unlockAudioOnce();
            e.dataTransfer.setData("text/plain", el.dataset.taskId);
          });
        });
      }

      function allow(e) {
        e.preventDefault();
      }

      function getTaskMinutes(taskEl) {
        const m = Number(taskEl.dataset.minutes || "0");
        return Number.isFinite(m) ? m : 0;
      }

      function sumMinutesInSlot(slotEl) {
        return Array.from(slotEl.querySelectorAll(".task")).reduce(
          (sum, t) => sum + getTaskMinutes(t),
          0
        );
      }

      function persistScheduleUI() {
        const map = {};

        document.querySelectorAll("#tasks .task").forEach((t) => {
          map[t.dataset.taskId] = "tasks";
        });

        document.querySelectorAll(".slot").forEach((slot) => {
          const time = slot.dataset.time;
          slot.querySelectorAll(".task").forEach((t) => {
            map[t.dataset.taskId] = time;
          });
        });

        saveState({ scheduleMap: map });
      }

      function restoreScheduleUI() {
        const s = loadState();
        const map = s.scheduleMap || null;
        if (!map) return;

        const tasksContainer = document.getElementById("tasks");
        document
          .querySelectorAll(".task")
          .forEach((t) => tasksContainer.appendChild(t));

        Object.entries(map).forEach(([taskId, place]) => {
          const taskEl = document.querySelector(
            `.task[data-task-id="${taskId}"]`
          );
          if (!taskEl) return;

          if (place === "tasks") {
            tasksContainer.appendChild(taskEl);
            return;
          }

          const slotEl = document.querySelector(`.slot[data-time="${place}"]`);
          if (slotEl) slotEl.appendChild(taskEl);
        });
      }

      function drop(e) {
        e.preventDefault();
        unlockAudioOnce();

        const taskId = e.dataTransfer.getData("text/plain");
        if (!taskId) return;

        const taskEl = document.querySelector(
          `.task[data-task-id="${taskId}"]`
        );
        if (!taskEl) return;

        const slotEl = e.target.closest(".slot");
        if (!slotEl) return;

        const slotTotal = sumMinutesInSlot(slotEl);
        const taskMinutes = getTaskMinutes(taskEl);

        if (slotTotal + taskMinutes > 60) {
          showMsg(
            `This time slot would exceed 60 minutes.\nCurrent: ${slotTotal} min, task: ${taskMinutes} min.`
          );
          return;
        }

        slotEl.appendChild(taskEl);
        persistScheduleUI();
      }

      function resetSchedule() {
        const tasksContainer = document.getElementById("tasks");
        document
          .querySelectorAll(".task")
          .forEach((t) => tasksContainer.appendChild(t));
        persistScheduleUI();
      }

      function submitExperiment() {
        const remaining = document.querySelectorAll("#tasks .task").length;
        if (remaining > 0) {
          showMsg("Please place all tasks into the schedule before finishing.");
          if (loadState().stressShown) showStress();
          return;
        }
        show("rate");
      }

      function getRadioValue(name) {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : "";
      }
      function setRadioValue(name, value) {
        const el = document.querySelector(
          `input[name="${name}"][value="${value}"]`
        );
        if (el) el.checked = true;
      }

      function persistDemoUI() {
        const speak_english = getRadioValue("speakEnglish");
        const ageStr = document.getElementById("ageInput").value.trim();
        const age = ageStr ? Number(ageStr) : "";
        const gender = getRadioValue("gender");
        const residence = getRadioValue("residence");
        const socioeconomic = getRadioValue("socioeconomic");
        const marital_status = getRadioValue("marital");
        const education = getRadioValue("education");

        saveState({
          demoDraft: {
            speak_english,
            age,
            gender,
            residence,
            socioeconomic,
            marital_status,
            education,
          },
        });
      }

      function restoreDemoUI() {
        const s = loadState();
        const d = s.demoDraft || {};
        if (d.speak_english) setRadioValue("speakEnglish", d.speak_english);
        if (d.age !== undefined && d.age !== "")
          document.getElementById("ageInput").value = String(d.age);
        if (d.gender) setRadioValue("gender", d.gender);
        if (d.residence) setRadioValue("residence", d.residence);
        if (d.socioeconomic) setRadioValue("socioeconomic", d.socioeconomic);
        if (d.marital_status) setRadioValue("marital", d.marital_status);
        if (d.education) setRadioValue("education", d.education);
      }

      function wireDemoAutosave() {
        [
          'input[name="speakEnglish"]',
          'input[name="gender"]',
          'input[name="residence"]',
          'input[name="socioeconomic"]',
          'input[name="marital"]',
          'input[name="education"]',
        ].forEach((sel) => {
          document
            .querySelectorAll(sel)
            .forEach((el) => el.addEventListener("change", persistDemoUI));
        });

        document
          .getElementById("ageInput")
          .addEventListener("input", persistDemoUI);
      }

      async function submitDemo() {
        const speak_english = getRadioValue("speakEnglish");
        const age = Number(document.getElementById("ageInput").value.trim());
        const gender = getRadioValue("gender");
        const residence = getRadioValue("residence");
        const socioeconomic = getRadioValue("socioeconomic");
        const marital_status = getRadioValue("marital");
        const education = getRadioValue("education");

        if (!speak_english) return alert("Please select if you speak English.");
        if (!Number.isInteger(age) || age < 18 || age > 99)
          return alert("Please enter a valid age between 18 and 99.");
        if (!gender) return alert("Please select gender.");
        if (!residence) return alert("Please select residence.");
        if (!socioeconomic) return alert("Please select socioeconomic status.");
        if (!marital_status) return alert("Please select marital status.");
        if (!education) return alert("Please select education level.");

        if (!pid)
          return alert(
            "Missing participant session. Please restart the experiment."
          );

        const res = await fetch(`/save/demo`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            participant_id: pid,
            data: {
              speak_english,
              age,
              gender,
              residence,
              socioeconomic,
              marital_status,
              education,
            },
          }),
        });

        if (!res.ok)
          return alert("Failed to save demographics. Please try again.");

        saveState({ demoCompleted: true });
        show("rep");
      }

      function persistRatingUI() {
        saveState({
          ratingDraft: document.getElementById("stressRating").value.trim(),
        });
      }
      function restoreRatingUI() {
        const s = loadState();
        if (s.ratingDraft !== undefined && s.ratingDraft !== null) {
          document.getElementById("stressRating").value = String(s.ratingDraft);
        }
      }

      async function consentAgree() {
        unlockAudioOnce();

        clearState();
        resetAllInputsAndScheduleUI();

        const resStart = await fetch("/start", { method: "POST" });
        const d = await resStart.json();

        pid = d.participant_id;
        stress = d.stress_condition;

        saveState({
          participant_id: pid,
          stress_condition: stress,
          history: ["consent"],
          currentPage: "consent",
          stressStarted: false,
          stressFireAt: null,
          stressShown: false,
          scheduleMap: null,
          repAnswers: null,
          demoDraft: {},
          ratingDraft: "",
        });

        await fetch("/save/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            participant_id: pid,
            data: { consent_given: 1 },
          }),
        });

        show("demo");
      }

      async function consentDisagree() {
        unlockAudioOnce();

        clearState();
        resetAllInputsAndScheduleUI();

        const resStart = await fetch("/start", { method: "POST" });
        const d = await resStart.json();

        pid = d.participant_id;
        stress = d.stress_condition;

        saveState({
          participant_id: pid,
          stress_condition: stress,
          history: ["consent"],
          currentPage: "consent",
        });

        await fetch("/save/consent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            participant_id: pid,
            data: { consent_given: 0 },
          }),
        });

        await fetch("/finish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ participant_id: pid }),
        });

        show("disagree");
      }

      async function finish() {
        const rating = Number(
          document.getElementById("stressRating").value.trim()
        );
        if (!Number.isInteger(rating) || rating < 1 || rating > 10) {
          document.getElementById("rateError").style.display = "block";
          return;
        }
        document.getElementById("rateError").style.display = "none";

        if (!pid)
          return alert(
            "Missing participant session. Please restart the experiment."
          );

        const r1 = await fetch(`/save/rating`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ participant_id: pid, data: { rating } }),
        });
        if (!r1.ok)
          return alert("Failed to save stress rating. Please try again.");

        const r2 = await fetch("/finish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ participant_id: pid }),
        });
        if (!r2.ok)
          return alert("Failed to finish the experiment. Please try again.");

        saveState({ completed: true, ratingDraft: String(rating) });
        show("done");
      }

      document.addEventListener("DOMContentLoaded", () => {
        ["pointerdown", "touchstart", "keydown", "mousedown"].forEach((evt) => {
          document.addEventListener(evt, unlockAudioOnce, { passive: true });
        });

        document.getElementById("msgOkBtn").addEventListener("click", () => {
          unlockAudioOnce();
          hideMsg();
          if (loadState().stressShown) startBeepLoop();
        });
        document.getElementById("msgBackdrop").addEventListener("click", () => {
          unlockAudioOnce();
          hideMsg();
          if (loadState().stressShown) startBeepLoop();
        });

        wireDemoAutosave();
        document
          .getElementById("stressRating")
          .addEventListener("input", persistRatingUI);

        const s = loadState();
        pid = s.participant_id || null;
        stress = s.stress_condition || 0;

        stressStarted = !!s.stressStarted;
        stressFireAt =
          typeof s.stressFireAt === "number" ? s.stressFireAt : null;
        stressShown = !!s.stressShown;

        if (!pid) {
          resetAllInputsAndScheduleUI();
          saveState({ history: ["consent"], currentPage: "consent" });
          show("consent", { pushHistory: false, force: true });
          return;
        }

        if (!Array.isArray(s.history) || s.history.length === 0) {
          saveState({ history: ["consent"] });
        }

        updateBackButton();

        const page = s.currentPage || "consent";
        show(page, { pushHistory: false, force: true });

        const h = getHistory();
        if (h[h.length - 1] !== page) {
          h.push(page);
          setHistory(h);
        } else {
          updateBackButton();
        }

        const expVisible = !document
          .getElementById("exp")
          .classList.contains("hidden");
        if (expVisible && loadState().stressShown) {
          document.getElementById("stress").classList.add("show");
        }
      });
    </script>
  </body>
</html>
